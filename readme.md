# AFORMES Web

# A-FORMS Optimizer

A-FORMS Optimizer - это набор модулей для оптимизации формы авиационных панелей под заданные нагрузки.

**Table of Contents**

- [Используемые технологии](#techs)
- [Установка](#installation)
- [Использование](#usage)
- [Спецификация файла panels_description](#panels_description)
- [Спецификация файла global_optimization_parameters](#global_optimization_parameters)

## techs 



## Установка и развертывание

Для работы сервиса необходимо наличие установленной субд PostgresQL, решателя FEMAP Nastran.

Для установки из репозитория:

1. Клонируете репозиторий в пустую директорию (например aforms_web)
```bash
git clone -b master https://github.com/hmcdl/aformes_web.git
```

2. Создаете виртуальное окружение для Python версии >=3.10
В директории aforms_web (Windows): 
```bash
<path/to/python.exe> -m venv venv
```
<path/to/python.exe> - путь к интерпретатору (по дефолту "c:\Users\Mikhail\AppData\Local\Programs\Python\Python3X\python.exe" где Х - версия Питона), venv - модуль для создания виртуального окружения, аргумент venv создаем папку "venv"

Активируем (Windows):
```bash
.\venv\Scripts\activate
```
3. установка зависимостей
```bash
pip install -r requirements.txt
```
2. Устанавливаете зависимости
```bash
pip install numpy, scipy
```
3. Добавляем секретные данные
 В той же директории создаем файл secret_data.py
В него:
```bash
SECRET_KEY = "09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 300
DATABASE_PASSWORD = 88495
```
Меняем SECRET_KEY и DATABASE_PASSWORD на акуальные. 
4. Задаем настройки в globals.py !!!Использовать прямые слэши!!!
Все эти данные задаются в соответствии с требованиями для запуска консольного приложения
sim_dir - Папка, где будут храниться проекты пользователей. !!!Вне репозитория!!!
"console_path" - путь к консольному приложению AFORMS
"solver" - путь к Фемапу
"PythonPath" - путь к интерпретатору питона, который используется в консольном приложении AFORMS. Можно задать тот же, что и при создании виртуального окружения
"optimizer_path" - путь к оптимизатору панелей
"panelcm" - путь к решателю Фомина
"materials" - путь к БД материалов
5. Создаем базу данных. Создание базы с пустыми таблицами производится из .sql файла в корне репозитория. Один из способов это сделать:
Открываем pgAdmin. Создаем сервер. В сервере создаем БД. В бд заходим в query tools, туда вставляем содержимое .sql файла 








## Использование
В данном разделе рассмотрена только та составляющая использования, которая касается запуска, входных и выходных данных. За описанием правил ***корректной*** работы с модулями
идите в doc/.

Существует два сценария использования A-FORMS Optimizer: в автоматическом режиме в связке с основной программой или в ручном режиме. Рассмотрим сначала ручной режим.

### Использование оптимизатора в ручном режиме

В ручном режиме при запуске модуля необходимо подать на вход программы два файла с параметрами: файл с характеристиками панелей и файл с параметрами оптимизации. 
| Параметр        | Тип           | Описание  |
| ------------- |:-------------:| -----|
| ``--panels_description``    | string |**Required**, Путь к файлу с описанием панелей |
| ``--global_optimization_parameters`` | string      | **Required**, Путь к файлу глобальных параметров оптимизации |

```bash
python optimizer_v1_1.py --panels_description путь/к/файлу/с/описанием/панелей.json --global_optimization_parameters путь/к/глобальным/параметрам/оптимизации.json
```

```bash
optimizer_v1_1.exe --panels_description путь/к/файлу/с/описанием/панелей.json --global_optimization_parameters путь/к/глобальным/параметрам/оптимизации.json
```
В директории optimization\panel_optimizer\demo\ находится демо-пример с оптимизацией одной панели

### Использование оптимизатора в связке с основным приложением A-FORMS

При использовании оптимизатора в связке с основным приложением запуск происходит в автоматическом режиме на этапе оптимизации. Файл panels_description генерируется основным приложением после определения нагрузок на панели, а файл global_optimization_parameters помещается в директорию с mdl3. Для того, чтобы происходила оптимизация необходимо при запуске A-FORMS добавить следующие параметры:

| Параметр        | Тип           | Описание  |
| ------------- |:-------------:| -----|
| ``--optimizer_path``    | string |**Required**, Путь к директории с оптимизационными модулями |
| ``--PythonPath`` | string      | **Optional**, Путь к интерпретатору Питона. Можно не указывать, если путь к интерпретатору прописан в переменных окружения ОС |
| ``--grad_opt`` | bool      | **Optional**,  флаг выполнения оптимизаии, по умолчанию 1|
| ``--manual_optimization_correction`` | bool      | **Optional**,  флаг паузы основной программы после завершения оптимизации для возможности проверки и коррекции|

В разделе demo\L410_single_iteration_with_optimization\ разобран пример с оптимизацией всех панелей конструкции.

В результате оптимизации создаются следующие файлы:

- **optimized_and_failed.json** - файл с характеристиками панелей после оптимизации. В файл включены все оптимизируемые панели вне зависимости от успешности оптимизации. 
-  **calculated_panels.json** - файл, сочетающий в себе параметры оптимизации и результаты оптимизации. Этот файл считывается основным приложением и в нем меняются диапазоны параметров. Но данный функционал пока заморожен, пааметры оптимизации задаются один раз перед стартом основного приложения. 
-  **optimization_log.json** - основной лог оптимизатора.
-  **PanelsLogs** - Папка с логами оптимизации всех отдельных панелей. Там можно посмотреть, какие значния параметров и ограничений были до оптимизации и после оптимизации. 

## Спецификация файла panels_description
Файл содержит в себе описание геометрии, физических характеристик панели и потоков усилий. Геометрическое и физическое описание панелей аналогично той, что используется в основном приложении.  Единицы измерения аналогичны единицам основного приложения: м, Н, кг. Типы потоков усилий различаются в зависимости от типа панели: Nx, Ny, Nxy - для панелей обшивки, sigma_max_flow_list, sigma_min_flow_list, sigma_y_flow_list, tau_xy_flow_list, top_flange_force_list, bot_flange_force_list - для панелей нервюр и лонжеронов. Описание потоков усилий, принимаемых для расчетов прочности и устойчивости см. в doc/Методика расчета панелей фюзеляжа, киля и стабилизатора. 
## Спецификация файла global_optimization_parameters
Файл global_optimization_parameters содержит в себе описание параметров оптимизации и содержит три раздела:

- sortaments - название сортамента и путь к нему (пример файла сортамента находится в doc/)
Пример
	``
	"sortaments" :
	[
		{"name" : "stringers", "path": "doc/Sortament_reduced.json"}
	]
	``
- groups - описание групп. Группа - это некая сущность, которая может выполнять одну из функций: 
	1. Это набор панелей, у которых после оптимизации некоторые параметры оптимизации должны совпадать.
	2. Это одна панель, но оптимизируемая по дискретному параметру (например, сортаменту).
В группе задается список панелей, и список варьируемых переменных. Каждая переменная имеет тип "real", название и границы в случае, если она относится к параметрам, известным основному приложению, либо тип "sortament" и указание на название сортамента из вкладки sortament
Пример
``
{

			"panels" : ["23.1.1", "23.2.1", "23.3.1"],
			"vars" : 
				[
					{"type" : "real", "content" : {"name" : "str_pitch", "min" : 0.08, "max" : 0.15, "num" : 3}},
					{"type" : "sortament", "content" : {"sortament" : "stringers"}}
				]
		}
		``
Группа панелей содержит группирующие переменные шага стрингера и сортамента. Шаг стрингера от 0.08 до 0.15 с 3 возможными значениями, распределенными равномерно в этом диапазоне. Сортамент берется из сортамента "stringers".
- panels - содержит перечисление фунций-ограничений с пороговыми значениями и переменных оптимизации с диапазоном варьирования для каждой панели. !!Переменные оптимизации не должны пересекаться с теми, что заданы в группах, если панель попала в группу. 
Функции-ограничения различаются для типов панелей. Для панелей обшивки возможны ограничения general_buckling, skin_local_bucklin, stringer_local_buckling, skin_strength, stringer_strength. Для панелей лонжеронов и нервюр возможны ограничения skin_local_buckling, skin_strength, flange_strength. 
Пример 
``
{
			"panel_code": "23.3.1",
			"function_constraints": {
				"general_buckling": 1.0,
				"skin_local_buckling": 1.0,
				"stringer_local_buckling": 1.0,
				"skin_strength": 1.0,
				"stringer_strength": 1.0
			},
			"opt_vars": {
				"h": {
					"min": 0.0008,
					"max": 0.02
				}
			}
		}
		``
		Панель имеет все возможные функции ограничения, но только одну переменную оптимизации, так как остальные уже подразумеваются в группе. 
		